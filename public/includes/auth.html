<?php
require_once __DIR__ . '/db.php';

function record_attempt($email) {
  $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
  $stmt = db()->prepare("INSERT INTO login_attempts (email, ip) VALUES (?, ?)");
  $stmt->bind_param('ss', $email, $ip);
  $stmt->execute();
  $stmt->close();
}

function too_many_attempts($email) {
  // Lockout if 5+ attempts in last 15 minutes for this email+IP
  $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
  $stmt = db()->prepare("
    SELECT COUNT(*) 
    FROM login_attempts 
    WHERE email = ? AND ip = ? AND attempted_at > (NOW() - INTERVAL 15 MINUTE)
  ");
  $stmt->bind_param('ss', $email, $ip);
  $stmt->execute();
  $stmt->bind_result($count);
  $stmt->fetch();
  $stmt->close();
  return ($count >= 5);
}

function clear_attempts($email) {
  $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
  $stmt = db()->prepare("DELETE FROM login_attempts WHERE email = ? AND ip = ?");
  $stmt->bind_param('ss', $email, $ip);
  $stmt->execute();
  $stmt->close();
}

function login($email, $password) {
  if (too_many_attempts($email)) {
    return ['ok' => false, 'msg' => 'Too many attempts. Try again in ~15 minutes.'];
  }

  $stmt = db()->prepare("SELECT id, name, email, password, grade, position FROM users WHERE email = ?");
  $stmt->bind_param('s', $email);
  $stmt->execute();
  $stmt->store_result();

  if ($stmt->num_rows !== 1) {
    $stmt->close();
    record_attempt($email);
    return ['ok' => false, 'msg' => 'Invalid email or password.'];
  }

  $stmt->bind_result($id, $name, $em, $hash, $grade, $position);
  $stmt->fetch();
  $stmt->close();

  if (!password_verify($password, $hash)) {
    record_attempt($email);
    return ['ok' => false, 'msg' => 'Invalid email or password.'];
  }

  // success
  clear_attempts($email);
  session_regenerate_id(true);
  $_SESSION['user'] = [
    'id' => $id,
    'name' => $name,
    'email' => $em,
    'grade' => $grade,
    'position' => $position
  ];
  return ['ok' => true];
}

function require_login() {
  if (empty($_SESSION['user'])) {
    header('Location: /login.php');
    exit();
  }
}

function current_user() {
  return $_SESSION['user'] ?? null;
}
